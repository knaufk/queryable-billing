<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8">

        <title>Queryable Billing</title>

        <meta name="description" content="How to Build a Billing System without a Database">
        <meta name="author" content="Maximilian Bode, Konstantin Knauf">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

        <link rel="stylesheet" href="css/reveal.min.css">
        <link rel="stylesheet" href="css/theme/tng.css" id="theme">
        <link rel="stylesheet" href="css/custom.css">
        <link rel="stylesheet" href="lib/css/github.css">

        <link rel="stylesheet" href="custom.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">


        <!-- Printing and PDF exports -->
        <script>
            var link = document.createElement( 'link' );
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
            document.getElementsByTagName( 'head' )[0].appendChild( link );
        </script>

        <!--[if lt IE 9]>
        <script src="lib/js/html5shiv.js"></script>
        <![endif]-->
    </head>

    <body>
        <div class="reveal">
            <div class="slides">
                <section data-markdown data-separator="^\n---\n$" data-separator-vertical="^\n--\n$" data-separator-notes="^\n\[\[">
                    <script type="text/template">
# Queryable Billing

&nbsp;

[Maximilian Bode](mailto:maximilian.bode@tngtech.com),
[Konstantin Knauf](mailto:konstantin.knauf@tngtech.com)

&nbsp;

<img src="img/tng.png" width="300">

--

## Who are we?

<img src="img/intro/konstantin.jpg" height="300" style="float:left">
<img src="img/intro/max.jpg" height="300" style="float:right">

- Background in maths & physics<!-- .element: class="fragment" -->
- Software Consultants<!-- .element: class="fragment" -->
- Interested in<!-- .element: class="fragment" -->
    - Distributed systems
    - Stream processing
- Flink in production for 1.5 y<!-- .element: class="fragment" -->

[[
* TNG Technology Consulting, a Munich-based consulting firm focused on high-end information technology
* both currently on a project with one of Europe’s largest telecommunications providers
* built a platform processing billions of events per day

--

### Agenda

1. Intro to Queryable State <!-- .element: class="fragment" -->
2. Use Case: A Queryable Billing System <!-- .element: class="fragment" -->
3. Live Demo of Our Prototype <!-- .element: class="fragment" -->

[[
* scope of our talk
* no performance benchmarks or throughput analyses, other talks & twitter benchmark
* rather: real use case inspired by customer's requirements prototypically implemented using queryable state

---

## Intro to Queryable State

--

### Evolution of Streaming Architecture
1. Lambda Architecture (Batch Layer & Speed Layer)<!-- .element: class="fragment" -->
2. Fault-Tolerant Stream Processor + External Key-Value Store<!-- .element: class="fragment" -->
3. Fault-Tolerant Stream Processor With Queryable State<!-- .element: class="fragment" -->

--

&lambda;

<img src="img/queryable-state/evolution-lambda.svg" width="800">

[[
<!-- TODO animate if not too complicated-->

--

&kappa;

<img src="img/queryable-state/evolution-kappa.svg" width="800">


--

Queryable State

<img src="img/queryable-state/evolution-queryable-state.svg" width="800">

[[
TODO

--

### High-Level Implementation

<img src="img/queryable-state/QueryableStateFlow.svg" width="1000">

---

## Use Case: Queryable Billing

--

### Requirements

--

<img src="img/queryable-billing/qb-sketch.png" width="800">

[[
* As the invoicing system I want to receive the total amount due at the end of each month, so that I can issue correct invoices to each customer.
* As a postpaid customer I want to be able check my current amount due during the month so that I can adjust my usage behaviour accordingly.
* As a marketing manager I want to know how much money my customers are currently spending on the different types of products to make real-time adjustments to my campaigns.

--

#### Quality Goals
<img src="img/queryable-billing/nfa.svg">

[[
* Completeness & Correctness
* Scalability
* Availability
* Robustness
    * Out-of-Order-Events
    * Late Arriving Events
    * Variable Volume
    * Partial Failures

--

### Architecture

--

#### High-Level
<img src="img/queryable-billing/architecture.svg"/>

[[

--

#### Flink Job
<img src="img/queryable-billing/qb-jobgraph.png" width="500" />

[[
* Flink Job
* Kafka Source
* TimeWindows
* Aggregation
* Queryable State
* BucketingSink
* Spring Boot Server
* QueryableStateClient
* Frontend

---

## Demo

--

### Invoice Generation

--

| Requirement   || Demo |
| ------------- ||:----:|
| Invoices      ||  <i class="fa fa-check new" aria-hidden="true"></i> |
| Live Updates  || |
| Correctness   ||  <span class="new">(<i class="fa fa-check" aria-hidden="true"></i>)</span>  |
| Availability  || |
| Scalability   || -|
| Robustness    |Late Events|  <i class="fa fa-check new" aria-hidden="true"></i> |
|               |Taskmanager| |
|               |Jobmanager | |
|               |Sink       | |


--

### Live Updates

--

| Requirement   || Demo |
| ------------- ||:----:|
| Invoices      ||  <i class="fa fa-check" aria-hidden="true"></i> |
| Live Updates  ||  <i class="fa fa-check new" aria-hidden="true"></i>|
| Correctness   ||  (<i class="fa fa-check" aria-hidden="true"></i>)|
| Availability  || |
| Scalability   || -|
| Robustness    |Late Events|  <i class="fa fa-check" aria-hidden="true"></i> |
|               |Taskmanager| |
|               |Jobmanager | |
|               |Sink       | |

--

### Taskmanager Failure

--

| Requirement   || Demo |
| ------------- ||:----:|
| Invoices      ||  <i class="fa fa-check" aria-hidden="true"></i> |
| Live Updates  ||  <i class="fa fa-check" aria-hidden="true"></i>|
| Correctness   ||  (<i class="fa fa-check" aria-hidden="true"></i>)|
| Availability  || <span class="new">(<i class="fa fa-check new" aria-hidden="true"></i>)</span>|
| Scalability   || -|
| Robustness    |Late Events| <i class="fa fa-check" aria-hidden="true"></i> |
|               |Taskmanager| <i class="fa fa-check new" aria-hidden="true"></i> |
|               |Jobmanager | |
|               |Sink       | |

--

### Jobmanager Failure

--

| Requirement   || Demo |
| ------------- ||:----:|
| Invoices      ||  <i class="fa fa-check" aria-hidden="true"></i> |
| Live Updates  ||  <i class="fa fa-check" aria-hidden="true"></i>|
| Correctness   ||  (<i class="fa fa-check" aria-hidden="true"></i>)|
| Availability  || (<i class="fa fa-check" aria-hidden="true"></i>)|
| Scalability   || -|
| Robustness    |Late Events| <i class="fa fa-check" aria-hidden="true"></i> |
|               |Taskmanager| <i class="fa fa-check" aria-hidden="true"></i> |
|               |Jobmanager | <i class="fa fa-check new" aria-hidden="true"></i> |
|               |Sink       | |

--

### Failure of Downstream Systems

--

| Requirement   || Demo |
| ------------- ||:----:|
| Invoices      ||  <i class="fa fa-check" aria-hidden="true"></i> |
| Live Updates  ||  <i class="fa fa-check" aria-hidden="true"></i>|
| Correctness   ||  <i class="fa fa-check new" aria-hidden="true"></i>|
| Availability  || <span class="new">(</span>(<i class="fa fa-check" aria-hidden="true"></i>)<span class="new">)</span>|
| Scalability   || -|
| Robustness    |Late Events| <i class="fa fa-check" aria-hidden="true"></i> |
|               |Taskmanager| <i class="fa fa-check" aria-hidden="true"></i> |
|               |Jobmanager | <i class="fa fa-check" aria-hidden="true"></i> |
|               |Sink       | <i class="fa fa-check new" aria-hidden="true"></i> |

---

## Limitations & Outlook

* Native support for Queryable State in windows <!-- .element: class="fragment" -->
* Improvements of client API <!-- .element: class="fragment" -->
* Availability in case of Job failures <!-- .element: class="fragment" -->

[[
Extends to other use cases

--

<table class="contacts">
    <tr>
        <td><i class="fa fa-envelope" aria-hidden="true"></i></td>
        <td><a href="mailto:maximilian.bode@tng.tech">maximilian.bode@tng.tech</a></td>
        <td><i class="fa fa-envelope" aria-hidden="true"></i></td>
        <td><a href="mailto:konstantin.knauf@tng.tech">konstantin.knauf@tng.tech</a></td>
    </tr>
    <tr>
        <td><i class="fa fa-linkedin" aria-hidden="true"></i></td>
        <td><a href="http://lnked.in/maxbode">lnked.in/maxbode</a></td>
        <td><i class="fa fa-twitter" aria-hidden="true"></i></td>
        <td><a href="https://twitter.com/snntrable">@snntrable</a></td>
    </tr>
</table>
<br/>
<a href="http://www.tngtech.com"><img class="logo" src="img/tng.png" width="300"></a>

</script>
                </section>
            </div>

            </div>
           <p class="copyright">© TNG Technology Consulting 2011 - 2017</p>
        </div>

        <script src="lib/js/head.js"></script>
        <script src="js/vendor/reveal.js"></script>

        <script>
            // Full list of configuration options available at:
            // https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                controls: true,
                progress: true,
                history: true,
                center: true,
                rollingLinks: false,
                width: 1024,
                height: 768,

                transition: 'slide', // none/fade/slide/convex/concave/zoom linear?

                markdown: {
                   smartypants: true
                },

                dependencies: [
                    { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
                    { src: 'plugin/markdown/marked.js' },
                    { src: 'plugin/markdown/markdown.js' },
                    { src: 'plugin/highlight/highlight.js', async: true, callback: function() {
                        hljs.initHighlightingOnLoad();
                        Array.prototype.forEach.call(document.querySelectorAll('pre>code'), function(node) {
                            var text = node.innerHTML;

                            text = text.replace(/\^([0-9]+)\^(((?!\^\^)(.|\n))*)\^\^/g, '<span class="fragment highlight" data-fragment-index="$1">$2</span>');
                            text = text.replace(/\^\^(((?!\^\^)(.|\n))*)\^\^/g, '<span class="highlight">$1</span>');

                            node.innerHTML = text;
                        });
                    } },
                    { src: 'plugin/zoom-js/zoom.js', async: true },
                    { src: 'plugin/notes/notes.js', async: true }
                ]
            });
        </script>

    </body>
</html>
